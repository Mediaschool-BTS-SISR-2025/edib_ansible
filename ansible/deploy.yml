---
- name: Deploy VM_Manager (backend + frontend)
  hosts: vmhosts
  become: true
  vars:
    repo_url: 'https://github.com/edib16/Vm_Manager.git'
    dest_path: '/home/{{ ansible_user }}/Vm_Manager'
    service_user: '{{ ansible_user }}'
    frontend_image: 'vm_manager_frontend:latest'

  tasks:
    - name: Ensure required packages are installed (Debian/Ubuntu)
      apt:
        name:
          - git
          - python3-venv
          - python3-pip
          - docker.io
        state: present
        update_cache: yes

    - name: Clone or update repository
      git:
        repo: '{{ repo_url }}'
        dest: '{{ dest_path }}'
        version: main
        force: yes

    - name: Ensure deploy.sh is executable
      file:
        path: '{{ dest_path }}/deploy.sh'
        mode: '0755'

    - name: Run deploy.sh to setup backend and systemd service (idempotent)
      command: './deploy.sh {{ service_user }}'
      args:
        chdir: '{{ dest_path }}'
        creates: '{{ dest_path }}/.venv/bin/activate'

    - name: Template .env.example from template
      template:
        src: 'templates/env.j2'
        dest: '{{ dest_path }}/.env.example'
      vars:
        secret_key: '{{ lookup("env", "SECRET_KEY") | default("dev-secret-change-me") }}'

    - name: Deploy systemd unit from template
      template:
        src: 'templates/vm_manager.service.j2'
        dest: '/etc/systemd/system/vm_manager.service'
        owner: root
        group: root
        mode: '0644'
      vars:
        dest_path: '{{ dest_path }}'
        service_user: '{{ service_user }}'
        venv_dir: '{{ dest_path }}/.venv'
        secret_key: '{{ lookup("env", "SECRET_KEY") | default("dev-secret-change-me") }}'
        gunicorn_workers: 3
        gunicorn_port: 5000

    - name: Reload systemd and restart vm_manager.service
      systemd:
        name: vm_manager.service
        daemon_reload: yes
        state: restarted

    - name: Build frontend Docker image using community.docker
      community.docker.docker_image:
        build:
          path: '{{ dest_path }}/frontend'
        name: '{{ frontend_image }}'
        source: build

    - name: Ensure old frontend container absent
      community.docker.docker_container:
        name: vm_frontend
        state: absent
        force_kill: true

    - name: Run frontend container
      community.docker.docker_container:
        name: vm_frontend
        image: '{{ frontend_image }}'
        state: started
        ports:
          - '8080:80'
        restart_policy: unless-stopped

    - name: Gather service facts and show vm_manager.service
      service_facts: {}

    - name: Print vm_manager service fact if present
      debug:
        var: ansible_facts.services['vm_manager.service']
      when: "ansible_facts.services is defined and 'vm_manager.service' in ansible_facts.services"
